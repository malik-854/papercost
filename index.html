<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Import Calculator - 2026</title>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f1f5f9; }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg); 
            padding: 10px; 
            font-size: 14px; 
            color: #334155; 
            margin: 0;
            -webkit-text-size-adjust: 100%;
        }
        .container { 
            max-width: 1100px; 
            margin: auto; 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 15px; 
        }
        .card { 
            background: white; 
            padding: 0;
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            overflow: hidden;
        }
        .card-content {
            padding: 15px;
        }
        h2 { 
            margin: 0;
            font-size: 0.95rem; 
            color: var(--accent); 
            text-transform: uppercase; 
        }
        .input-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        @media (min-width: 768px) {
            .container { grid-template-columns: 1fr 1fr; }
            .input-grid { grid-template-columns: 1fr 1fr; }
        }
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 3px; 
            color: #475569; 
            font-size: 13px;
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #cbd5e1; 
            border-radius: 6px; 
            font-size: 14px; 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .results-table { 
            width: 100%; 
            border-collapse: collapse;
            font-size: 13px;
        }
        .results-table td { 
            padding: 10px 0; 
            border-bottom: 1px solid #f1f5f9; 
        }
        .results-table td:last-child { 
            text-align: right; 
            font-weight: bold; 
        }
        .total-row { 
            font-size: 1.1rem; 
            color: #be123c; 
            border-top: 2px solid #334155 !important; 
        }
        .final-cost-banner {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border: none;
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .final-cost-banner:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
        }
        .copy-icon {
            font-size: 18px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
            border-radius: 4px;
            min-width: 30px;
            text-align: center;
        }
        .cost-value {
            flex-grow: 1;
            text-align: center;
        }
        .hidden { display: none; }
        .hs-manager { 
            background: #f8fafc; 
            padding: 12px; 
            border-radius: 6px; 
            margin-top: 15px; 
            border: 1px solid #e2e8f0; 
        }
        .hs-manager input { 
            margin-right: 0;
            margin-bottom: 8px; 
            width: 100%;
        }
        @media (min-width: 480px) {
            .hs-manager input { 
                width: auto;
                margin-right: 10px;
            }
        }
        .btn-small { 
            background: var(--accent); 
            color: white; 
            padding: 8px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px; 
            display: inline-block;
            margin-top: 5px;
        }
        .save-all-button {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .save-all-button:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.3);
        }
        .save-notice { 
            background: #dbeafe; 
            padding: 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            color: #1e40af; 
            margin-top: 10px; 
            display: none; 
        }
        .toggle-section {
            background: #f1f5f9;
            padding: 12px 15px;
            border-radius: 0;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }
        .toggle-section:hover {
            background: #e2e8f0;
        }
        .toggle-icon {
            font-weight: bold;
            font-size: 16px;
            color: #475569;
            transition: transform 0.3s ease;
        }
        .toggle-section.active .toggle-icon {
            transform: rotate(180deg);
        }
        .section-content {
            transition: all 0.3s ease;
            max-height: 2000px;
            overflow: hidden;
        }
        .collapsed {
            max-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden;
            opacity: 0;
            border: none !important;
        }
        .header-bar {
            background: var(--primary);
            color: white;
            padding: 20px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        .header-title {
            margin: 0;
            font-size: 1.2rem;
            line-height: 1.3;
        }
        .mobile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .mobile-actions button {
            flex: 1;
            min-width: 120px;
        }
        /* Improve touch targets */
        button, input[type="button"], input[type="submit"] {
            min-height: 44px;
            touch-action: manipulation;
        }
        select {
            min-height: 44px;
        }
        /* Scroll improvements */
        .scrollable-section {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-right: 5px;
        }
        .scrollable-section::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .scrollable-section::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .copy-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #059669;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .save-section-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 15px;
            text-align: center;
        }
        .save-section-card h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #059669;
            font-size: 1rem;
        }
        
        /* RED BANNER STYLES - ADDED HERE */
        .red-banner {
            top: 70px !important;
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3) !important;
        }
        .red-banner:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4) !important;
        }
        /* Adjust positions */
        .final-cost-banner {
            top: 10px;
        }
        .red-banner {
            top: 70px;
        }
    </style>
</head>
<body>

<div class="final-cost-banner" onclick="copyFinalCost()" id="finalCostBanner">
    <div class="cost-value" id="finalCostValue">Rs. 0.00 /kg LHR</div>
</div>

<div class="final-cost-banner red-banner" onclick="copyNetCost()" id="netCostBanner">
    <div class="cost-value" id="netCostValue">Rs. 0.00 /kg KHI</div>
</div>

<div class="copy-notification" id="copyNotification">
    Copied to clipboard! ‚úì
</div>

<div class="container">
    <div class="header-bar">
        <h1 class="header-title">Pakistan Multi-Incoterm Import Calculator</h1>
        <div class="mobile-actions">
            <button class="btn-small" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn-small" onclick="resetToDefaults()" style="background: #dc2626;">üîÑ Reset</button>
        </div>
    </div>

    <div class="card">
        <div class="toggle-section active" onclick="toggleSection('commercial-section', this)">
            <h2>1. Commercial & Valuation</h2>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content card-content" id="commercial-section">
            <div class="input-grid">
                <div style="grid-column: 1 / -1;">
                    <label>HS Code Preset</label>
                    <select id="hs_code" onchange="loadHsCodeSettings()">
                        <!-- Options will be loaded from localStorage -->
                    </select>
                </div>
                <div>
                    <label>Origin of Product</label>
                    <select id="origin" onchange="loadHsCodeSettings()">
                        <option value="china">China</option>
                        <option value="indonesia">Indonesia</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label>Rate Type</label>
                    <select id="incoterm" onchange="handleIncotermChange()">
                        <option value="cnf">C&F (Cost & Freight)</option>
                        <option value="fob">FOB (Free on Board)</option>
                    </select>
                </div>
                <div><label>Unit Price (USD/Ton)</label><input type="number" id="unit_price" value="750" oninput="calculate()"></div>
                
                <div id="box_freight" class="hidden"><label>Sea Freight (USD Total)</label><input type="number" id="freight_usd" value="1200" oninput="calculate()"></div>
                <div id="box_insurance" class="hidden"><label>Insurance (% of ITP)</label><input type="number" id="insurance_percent" value="0.15" step="0.01" oninput="calculate()"></div>
                
                <div><label>ITP Value (USD/Ton)</label><input type="number" id="itp_val" value="750" step="0.01" oninput="calculate()"></div>
                <div><label>Ex. Rate (PKR)</label><input type="number" id="ex_rate" value="282" oninput="calculate()"></div>
                <div><label>Quantity (Tons)</label><input type="number" id="qty" value="20" oninput="calculate()"></div>
            </div>

            <div class="hs-manager">
                <h3 style="margin-top:0; font-size: 0.9rem; color: #475569;">Add/Manage HS Codes</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                    <input type="text" id="new_hs_code" placeholder="HS Code" style="flex: 1; min-width: 120px;">
                    <input type="text" id="new_hs_description" placeholder="Description" style="flex: 2; min-width: 150px;">
                    <button class="btn-small" onclick="addHsCode()">‚ûï Add</button>
                    <button class="btn-small" onclick="deleteCurrentHsCode()" style="background: #dc2626;">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="toggle-section" onclick="toggleSection('tax-section', this)">
            <h2>2. Fully Editable Tax Rates (%)</h2>
            <span class="toggle-icon">‚ñ∂</span>
        </div>
        <div class="section-content card-content scrollable-section" id="tax-section">
            <div class="input-grid">
                <div><label>CD (%)</label><input type="number" id="rate_cd" value="15" oninput="calculate()"></div>
                <div><label>ACD (%)</label><input type="number" id="rate_acd" value="2" oninput="calculate()"></div>
                <div><label>RD (%)</label><input type="number" id="rate_rd" value="10" oninput="calculate()"></div>
                <div><label>Anti-Dump (%)</label><input type="number" id="rate_add" value="0" oninput="calculate()"></div>
                <div><label>GST (%)</label><input type="number" id="rate_st" value="18" oninput="calculate()"></div>
                <div><label>AST (%)</label><input type="number" id="rate_ast" value="3" oninput="calculate()"></div>
                <div><label>Income Tax (%)</label><input type="number" id="rate_it" value="12" oninput="calculate()"></div>
                <div><label>Sindh Cess (%)</label><input type="number" id="rate_cess" value="1.85" step="0.01" oninput="calculate()"></div>
                <!-- Landing Charges Field Added -->
                <div><label>Landing Charges (%)</label><input type="number" id="rate_landing" value="1" step="0.01" oninput="calculate()"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="toggle-section" onclick="toggleSection('summary-section', this)">
            <h2>3. Landing Summary & Local Charges</h2>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content card-content" id="summary-section">
            <table class="results-table">
                <tr><td>Invoice Value (USD)</td><td id="out_inv_usd">0</td></tr>
                <tr><td>Total Shipping Cost (PKR)</td><td id="out_ship_pkr">0</td></tr>
                <tr><td>Assessed Value (FBR Base)</td><td id="out_assessed">0</td></tr>
                <tr><td>Customs Duty (CD)</td><td id="out_cd">0</td></tr>
                <tr><td>Add. Customs Duty (ACD)</td><td id="out_acd">0</td></tr>
                <tr><td>Regulatory Duty (RD)</td><td id="out_rd">0</td></tr>
                <tr><td>Anti-Dumping (ADD)</td><td id="out_add">0</td></tr>
                <tr><td>Sales Tax (GST + AST)</td><td id="out_st">0</td></tr>
                <tr><td>Income Tax (WHT)</td><td id="out_it">0</td></tr>
                <tr><td>Port/Cess/Local</td><td id="out_local">0</td></tr>
                <!-- Landing Charges Row Added -->
                <tr><td>Landing Charges (1%)</td><td id="out_landing">0</td></tr>
                <tr class="total-row"><td>Landed Cost / KG</td><td id="out_kg">Rs. 0.00</td></tr>
            </table>
            
            <div style="margin-top:20px;">
                <label>Port/Clearing PKR (Per KG)</label>
                <input type="number" id="port_pkr" value="5" step="0.01" oninput="calculate()">
                <label style="margin-top: 10px; display: block;">Trucking to Warehouse (PKR/KG)</label>
                <input type="number" id="truck_pkr" value="12" step="0.01" oninput="calculate()">
            </div>
            
            <button class="btn-small" onclick="window.print()" style="width: 100%; margin-top: 15px;">üñ®Ô∏è Print Full Calculation</button>
        </div>
    </div>

    <div class="save-section-card">
        <button class="save-all-button" onclick="saveAllSettingsToHsCode()">
            <span>üíæ</span>
            Save ALL Settings to Current HS Code
        </button>
        <div id="save-notice" class="save-notice">Settings saved successfully!</div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- 1. YOUR SPECIFIC FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAqpYFx4SnulY3ctPPqsepymUz4qUsJUG0",
        authDomain: "import-calculator-2a301.firebaseapp.com",
        projectId: "import-calculator-2a301",
        storageBucket: "import-calculator-2a301.firebasestorage.app",
        messagingSenderId: "485001969088",
        appId: "1:485001969088:web:518b99e62a8840bb699c25"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const hsCollection = db.collection('hs_codes');

    const DEFAULT_VALUES = {
        origin: 'china', 
        incoterm: 'cnf',  // Changed from 'cif' to 'cnf'
        unit_price: 750, 
        freight_usd: 1200, 
        insurance_percent: 0.15,  // Changed from insurance_usd to insurance_percent
        itp_val: 750, 
        ex_rate: 282, 
        qty: 20, 
        port_pkr: 5,  // Per KG rate (adds Rs. 5/kg to cost)
        truck_pkr: 12, 
        rate_cd: 15, 
        rate_acd: 2, 
        rate_rd: 10, 
        rate_add: 0, 
        rate_st: 18, 
        rate_ast: 3, 
        rate_it: 12, 
        rate_cess: 1.85, 
        rate_landing: 1
    };

    // --- 2. CLOUD DATA FUNCTIONS ---

    async function loadHsCodes() {
        const select = document.getElementById('hs_code');
        select.innerHTML = '<option disabled selected>Connecting to cloud...</option>';
        
        try {
            const snapshot = await hsCollection.get();
            select.innerHTML = '<option value="" disabled selected>-- Select HS Code --</option>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${doc.id} - ${data.description || ''}`;
                select.appendChild(option);
            });

            const lastHs = localStorage.getItem('lastHsCode');
            if (lastHs) {
                select.value = lastHs;
                loadHsCodeSettings();
            }
        } catch (e) {
            console.error("Cloud Error:", e);
        }
    }

    async function addHsCode() {
        const code = document.getElementById('new_hs_code').value.trim();
        const desc = document.getElementById('new_hs_description').value.trim();
        if (!code || !desc) return alert('Enter HS Code and Description');

        await hsCollection.doc(code).set({ description: desc }, { merge: true });
        document.getElementById('new_hs_code').value = '';
        document.getElementById('new_hs_description').value = '';
        loadHsCodes();
        showNotice(`‚úÖ ${code} added to Cloud!`);
    }

    async function saveAllSettingsToHsCode() {
        const hsCode = document.getElementById('hs_code').value;
        const origin = document.getElementById('origin').value;
        
        if (!hsCode) return alert('Select an HS Code first');

        const settings = {
            origin: origin,
            incoterm: document.getElementById('incoterm').value,
            unit_price: parseFloat(document.getElementById('unit_price').value),
            freight_usd: parseFloat(document.getElementById('freight_usd').value),
            insurance_percent: parseFloat(document.getElementById('insurance_percent').value),
            itp_val: parseFloat(document.getElementById('itp_val').value),
            ex_rate: parseFloat(document.getElementById('ex_rate').value),
            qty: parseFloat(document.getElementById('qty').value),
            port_pkr: parseFloat(document.getElementById('port_pkr').value),
            truck_pkr: parseFloat(document.getElementById('truck_pkr').value),
            rate_cd: parseFloat(document.getElementById('rate_cd').value),
            rate_acd: parseFloat(document.getElementById('rate_acd').value),
            rate_rd: parseFloat(document.getElementById('rate_rd').value),
            rate_add: parseFloat(document.getElementById('rate_add').value),
            rate_st: parseFloat(document.getElementById('rate_st').value),
            rate_ast: parseFloat(document.getElementById('rate_ast').value),
            rate_it: parseFloat(document.getElementById('rate_it').value),
            rate_cess: parseFloat(document.getElementById('rate_cess').value),
            rate_landing: parseFloat(document.getElementById('rate_landing').value),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            // Create a nested structure: hs_code -> origins -> origin_specific_data
            const originSettings = {};
            originSettings[origin] = settings;
            
            await hsCollection.doc(hsCode).set({
                description: document.querySelector(`#hs_code option[value="${hsCode}"]`)?.textContent?.split(' - ')[1] || '',
                origins: firebase.firestore.FieldValue.arrayUnion(origin),
                [`origin_${origin}`]: settings,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            showNotice(`‚úÖ Settings saved for ${hsCode} - ${origin.toUpperCase()}`, "#d1fae5", "#065f46");
            
            // Update localStorage with the current HS Code
            localStorage.setItem('lastHsCode', hsCode);
            localStorage.setItem(`lastOrigin_${hsCode}`, origin);
            
        } catch (e) {
            alert("Sync Failed: " + e.message);
        }
    }

    async function loadHsCodeSettings() {
        const hsCode = document.getElementById('hs_code').value;
        const origin = document.getElementById('origin').value;
        
        if (!hsCode) return;
        
        try {
            localStorage.setItem('lastHsCode', hsCode);
            localStorage.setItem(`lastOrigin_${hsCode}`, origin);
            
            const doc = await hsCollection.doc(hsCode).get();
            if (!doc.exists) {
                // No saved data for this HS Code, load defaults
                resetToDefaultsForOrigin(origin);
                return;
            }
            
            const data = doc.data();
            
            // Check if we have settings for this specific origin
            const originKey = `origin_${origin}`;
            
            if (data[originKey]) {
                // Load origin-specific settings
                const originData = data[originKey];
                
                // Map cloud data back to input fields
                Object.keys(DEFAULT_VALUES).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && originData[key] !== undefined) {
                        el.value = originData[key];
                    }
                });
                
                // Update the origin dropdown to match loaded data
                if (originData.origin) {
                    document.getElementById('origin').value = originData.origin;
                }
                
                showNotice(`‚úÖ Loaded ${hsCode} - ${origin.toUpperCase()} settings`, "#dbeafe", "#1e40af");
            } else {
                // No settings for this origin, load defaults
                resetToDefaultsForOrigin(origin);
                showNotice(`‚ö†Ô∏è No saved settings for ${origin.toUpperCase()}, using defaults`, "#fef3c7", "#92400e");
            }
            
            handleIncotermChange();
            calculate();
            
        } catch (e) {
            console.error("Load Error:", e);
            resetToDefaultsForOrigin(origin);
        }
    }

    function resetToDefaultsForOrigin(origin) {
        // Reset to default values
        Object.keys(DEFAULT_VALUES).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                el.value = DEFAULT_VALUES[key];
            }
        });
        
        // Set the origin
        document.getElementById('origin').value = origin;
        handleIncotermChange();
        calculate();
    }

    async function deleteCurrentHsCode() {
        const code = document.getElementById('hs_code').value;
        if (!code || !confirm(`Delete ${code} from Cloud? This will delete ALL origin settings for this HS Code.`)) return;
        
        await hsCollection.doc(code).delete();
        loadHsCodes();
        
        // Clear localStorage for this HS Code
        localStorage.removeItem('lastHsCode');
        for (let key in localStorage) {
            if (key.startsWith(`lastOrigin_${code}`)) {
                localStorage.removeItem(key);
            }
        }
    }

    // --- 3. UI & CALCULATION LOGIC ---

    function toggleSection(sectionId, toggleElement) {
        const section = document.getElementById(sectionId);
        const isCollapsed = section.classList.contains('collapsed');
        
        section.classList.toggle('collapsed');
        toggleElement.classList.toggle('active');
        toggleElement.querySelector('.toggle-icon').textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
        
        if (isCollapsed) {
            section.style.maxHeight = section.scrollHeight + "px";
            section.style.opacity = "1";
        } else {
            section.style.maxHeight = "0";
            section.style.opacity = "0";
        }
    }

    function handleIncotermChange() {
        const term = document.getElementById('incoterm').value;
        document.getElementById('box_freight').className = (term === 'fob') ? '' : 'hidden';
        document.getElementById('box_insurance').className = (term === 'fob' || term === 'cnf') ? '' : 'hidden';
        calculate();
    }

    function calculate() {
        const term = document.getElementById('incoterm').value;
        const unitPrice = parseFloat(document.getElementById('unit_price').value) || 0;
        const qty = parseFloat(document.getElementById('qty').value) || 0;
        const exRate = parseFloat(document.getElementById('ex_rate').value) || 0;
        const itpVal = parseFloat(document.getElementById('itp_val').value) || 0;

        // Calculate max value (for assessed value)
        let maxValuePerTon = Math.max(unitPrice, itpVal);
        
        // Invoice value (actual purchase)
        let invUsd = unitPrice * qty;
        
        // Freight (only for FOB)
        let freightUsd = (term === 'fob') ? parseFloat(document.getElementById('freight_usd').value) || 0 : 0;
        
        // Insurance (0.15% of ITP value for C&F and FOB)
        let insuranceUsd = 0;
        if (term === 'fob' || term === 'cnf') {
            let insurancePercent = parseFloat(document.getElementById('insurance_percent').value) || 0;
            insuranceUsd = itpVal * qty * (insurancePercent / 100); // Based on ITP only
        }
        
        // Actual cost in PKR (what you actually pay)
        let actualCostPkr = (invUsd + freightUsd + insuranceUsd) * exRate;
        
        // Assessed value for customs (using max of unit price or ITP)
        let assessedValuePkr = (maxValuePerTon * qty + (term === 'fob' ? freightUsd : 0) + insuranceUsd) * exRate;

        // Calculate duties and taxes
        const cd = assessedValuePkr * (parseFloat(document.getElementById('rate_cd').value)/100);
        const acd = assessedValuePkr * (parseFloat(document.getElementById('rate_acd').value)/100);
        const rd = assessedValuePkr * (parseFloat(document.getElementById('rate_rd').value)/100);
        const add = assessedValuePkr * (parseFloat(document.getElementById('rate_add').value)/100);
        
        const stBase = assessedValuePkr + cd + acd + rd + add;
        const gst = stBase * (parseFloat(document.getElementById('rate_st').value)/100);
        const ast = stBase * (parseFloat(document.getElementById('rate_ast').value)/100);
        const it = (stBase + gst + ast) * (parseFloat(document.getElementById('rate_it').value)/100);
        const cess = assessedValuePkr * (parseFloat(document.getElementById('rate_cess').value)/100);
        const landing = assessedValuePkr * (parseFloat(document.getElementById('rate_landing').value)/100);
        
        // Port charges (Rs. 5 per kg - adds flat Rs. 5 to cost per kg)
        const portPerKg = parseFloat(document.getElementById('port_pkr').value) || 0;
        const portTotal = (qty * 1000) * portPerKg;
        
        // Trucking (Rs. 12 per kg)
        const truckPerKg = parseFloat(document.getElementById('truck_pkr').value) || 0;
        const truckTotal = (qty * 1000) * truckPerKg;

        // Calculate grand total
        const grandTotal = actualCostPkr + cd + acd + rd + add + gst + ast + it + cess + landing + portTotal + truckTotal;
        const costPerKg = grandTotal / (qty * 1000);

        // Update display
        document.getElementById('out_inv_usd').innerText = "$" + invUsd.toLocaleString();
        document.getElementById('out_ship_pkr').innerText = Math.round((freightUsd + insuranceUsd) * exRate).toLocaleString();
        document.getElementById('out_assessed').innerText = Math.round(assessedValuePkr).toLocaleString();
        document.getElementById('out_cd').innerText = Math.round(cd).toLocaleString();
        document.getElementById('out_acd').innerText = Math.round(acd).toLocaleString();
        document.getElementById('out_rd').innerText = Math.round(rd).toLocaleString();
        document.getElementById('out_add').innerText = Math.round(add).toLocaleString();
        document.getElementById('out_st').innerText = Math.round(gst + ast).toLocaleString();
        document.getElementById('out_it').innerText = Math.round(it).toLocaleString();
        document.getElementById('out_local').innerText = Math.round(cess + portTotal).toLocaleString();
        document.getElementById('out_landing').innerText = Math.round(landing).toLocaleString();
        document.getElementById('out_kg').innerText = "Rs. " + costPerKg.toFixed(2);
        document.getElementById('finalCostValue').textContent = "Rs. " + Math.round(costPerKg).toLocaleString() + " /kg LHR";

const netCostPerKg = costPerKg - truckPerKg;
        document.getElementById('netCostValue').textContent = "Rs. " + Math.round(netCostPerKg).toLocaleString() + " /kg KHI";
    }

    function showNotice(msg, bg="#dbeafe", color="#1e40af") {
        const notice = document.getElementById('save-notice');
        if (!notice) return;
        notice.style.display = 'block';
        notice.textContent = msg;
        notice.style.background = bg;
        notice.style.color = color;
        setTimeout(() => notice.style.display = 'none', 3000);
    }

    function copyFinalCost() {
        const val = document.getElementById('finalCostValue').textContent.split(' ')[1];
        navigator.clipboard.writeText(val);
        
        // Show copy notification
        const notification = document.getElementById('copyNotification');
        notification.style.display = 'block';
        setTimeout(() => notification.style.display = 'none', 2000);
    }

// ADD THIS AFTER THE copyFinalCost() FUNCTION

function copyNetCost() {
    const val = document.getElementById('netCostValue').textContent.split(' ')[1];
    navigator.clipboard.writeText(val);
    
    // Show copy notification
    const notification = document.getElementById('copyNotification');
    notification.textContent = "Net cost copied to clipboard! ‚úì";
    notification.style.display = 'block';
    setTimeout(() => notification.style.display = 'none', 2000);
}

    function resetToDefaults() {
        if (confirm('Reset all fields to default values? This will not delete saved cloud data.')) {
            const currentOrigin = document.getElementById('origin').value;
            resetToDefaultsForOrigin(currentOrigin);
            showNotice("üîÑ Reset to defaults", "#fef3c7", "#92400e");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadHsCodes();
        document.getElementById('summary-section').classList.add('collapsed');
        document.getElementById('tax-section').classList.add('collapsed');
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', calculate));
        
        // Load last used origin for the current HS Code if available
        const hsSelect = document.getElementById('hs_code');
        hsSelect.addEventListener('change', function() {
            const hsCode = this.value;
            if (hsCode) {
                const lastOrigin = localStorage.getItem(`lastOrigin_${hsCode}`);
                if (lastOrigin) {
                    document.getElementById('origin').value = lastOrigin;
                }
            }
        });
    });
</script>
</body>
</html>